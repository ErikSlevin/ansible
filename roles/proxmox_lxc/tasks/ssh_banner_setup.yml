---
# SSH-Banner Setup mit Sicherheitskonfiguration
# Erstellt personalisierten SSH-Banner und hÃ¤rtet SSH-Konfiguration

- name: "Erstelle SSH-Banner fÃ¼r {{ container_hostname }}"
  shell: |
    # TemporÃ¤res Banner erstellen
    cat > /tmp/ssh_banner_{{ container_id }}.txt << 'EOF'

    ################################################################################
    #
    #  ğŸ–¥ï¸  PROXMOX LXC CONTAINER [{{ container_id }}] - {{ container_hostname }}
    #
    #  âš ï¸  AUTORISIERTER ZUGANG ERFORDERLICH
    #
    #  Dieses System ist nur fÃ¼r autorisierte Benutzer bestimmt.
    #  Alle AktivitÃ¤ten werden Ã¼berwacht und protokolliert.
    #  
    #  Unbefugter Zugang ist strengstens untersagt und kann straf-
    #  und zivilrechtliche Konsequenzen haben.
    #
    #  ğŸ“… Container erstellt: {{ ansible_date_time.date }}
    #  ğŸ”— VLAN: {{ container_vlan }}
    #
    ################################################################################

    EOF

    # Banner in Container kopieren
    pct push {{ container_id }} /tmp/ssh_banner_{{ container_id }}.txt /etc/ssh/ssh_banner.txt

    # SSH-Konfiguration anpassen
    pct exec {{ container_id }} -- bash -c '
    # Banner aktivieren
    sed -i "s|#Banner.*|Banner /etc/ssh/ssh_banner.txt|" /etc/ssh/sshd_config

    # ZusÃ¤tzliche SSH-HÃ¤rtung
    sed -i "s|#ClientAliveInterval.*|ClientAliveInterval 300|" /etc/ssh/sshd_config
    sed -i "s|#ClientAliveCountMax.*|ClientAliveCountMax 2|" /etc/ssh/sshd_config
    sed -i "s|#MaxAuthTries.*|MaxAuthTries 3|" /etc/ssh/sshd_config
    sed -i "s|#MaxSessions.*|MaxSessions 2|" /etc/ssh/sshd_config

    # SSH-Service neu starten
    systemctl restart ssh
    systemctl enable ssh
    '

    # TemporÃ¤re Datei aufrÃ¤umen
    rm -f /tmp/ssh_banner_{{ container_id }}.txt

    # Konfiguration validieren
    pct exec {{ container_id }} -- grep -q "^Banner" /etc/ssh/sshd_config
  register: ssh_banner_result
  changed_when: ssh_banner_result.rc == 0
  failed_when: ssh_banner_result.rc != 0
  tags: [ssh_banner, ssh_hardening, security]

- name: "SSH-Banner und Sicherheit konfiguriert"
  debug:
    msg: |
      âœ… SSH-Sicherheit fÃ¼r {{ container_hostname }} konfiguriert!
      - Personalisierter Banner aktiviert
      - SSH-Verbindungszeiten begrenzt
      - Authentifizierungs-Versuche limitiert
      - SSH-Service neu gestartet
  tags: [ssh_summary]
