---
# SSH Banner Setup für Container
- name: "SSH-Banner konfigurieren"
  shell: |
    # Banner direkt erstellen (ohne Template-Datei)
    cat > /tmp/ssh_banner_{{ container_id }}.txt << 'EOF'

    ################################################################################
    #  [{{ container_id }}] - {{ container_hostname }}
    #
    #  AUTHORIZED ACCESS ONLY                                                      
    #  This system is for authorized users only. All activities may be           
    #  monitored and recorded. Unauthorized access is strictly prohibited.       
    #                                                                             
    ################################################################################

    EOF

    # Banner in Container kopieren und SSH konfigurieren
    pct push {{ container_id }} /tmp/ssh_banner_{{ container_id }}.txt /etc/ssh/ssh_banner.txt &&
    pct exec {{ container_id }} -- sed -i 's/#Banner none/Banner \/etc\/ssh\/ssh_banner.txt/' /etc/ssh/sshd_config &&
    pct exec {{ container_id }} -- systemctl restart ssh &&

    # Aufräumen
    rm -f /tmp/ssh_banner_{{ container_id }}.txt &&

    # Erfolg bestätigen
    pct exec {{ container_id }} -- grep -q '^Banner' /etc/ssh/sshd_config

  register: ssh_banner_result
  changed_when: ssh_banner_result.rc == 0
  failed_when: ssh_banner_result.rc != 0
  no_log: true
  tags: [ssh_banner, security]
