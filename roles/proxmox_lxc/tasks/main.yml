# Hauptsteuerung der proxmox_lxc Rolle
# Erstellt und konfiguriert LXC Container auf Proxmox VE

- name: "Vorbereitung und Validierung"
  block:
    - name: "Container-ID-Management"
      include_tasks: id_management.yml
      tags: [preparation, id_management]

    - name: "Validierung der Container-ID"
      include_tasks: validation.yml
      tags: [preparation, validation]

- name: "Container-Erstellung"
  block:
    - name: "Schritt {{ step_counter }}: LXC Container erstellen"
      include_tasks: container_create.yml
      tags: [deployment, container_create]

    - name: "Container starten und ueberwachen"
      include_tasks: container_start.yml
      tags: [deployment, container_start]
  rescue:
    - name: "Fehlerbehandlung: Container bei Problemen entfernen"
      shell: "pct destroy {{ container_id }} --force"
      ignore_errors: true
      when: container_id is defined
      tags: [cleanup]

- name: "Post-Deployment Konfiguration"
  block:
    - name: "Basis-System konfigurieren"
      include_tasks: container_setup.yml
      when: container_setup_enabled | default(true)
      tags: [configuration, system_setup]

    - name: "SSH-Banner einrichten"
      include_tasks: ssh_banner_setup.yml
      when: container_setup_enabled | default(true)
      tags: [configuration, ssh_setup, security]

- name: "UniFi-Integration"
  block:
    - name: "UniFi-Registrierung vorbereiten"
      include_tasks: unify_manual.yml
      when: show_unify_commands | default(true)
      tags: [unifi, manual_commands]
